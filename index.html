<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
        <script type = "text/javascript" language = "javascript">
            var mqtt;
            var reconnectTimeout = 4000;
            var host = "test.mosquitto.org";
            var port = 8081;
            var connection_flag = 0;

            function onConnectionLost() {
                console.log("Connection lost");
                connection_flag = 0;
            }

            function onConnect() {
                var tmpStr = "Connected to " + host + " on port " + port;
                document.getElementById("constatus").innerHTML = tmpStr;
                console.log("tmpStr");
                connection_flag = 1;
            }

            function onConnected(recon, url){
                console.log("onConnected");
            }

            function onFailure(){
                var tmpStr = "Connection Attempt to Host " + host + "Failed. Attempting to Reconnect.";
                document.getElementById("constatus").innerHTML = tmpStr;
                console.log(tmpStr);
                setTimeout(MQTTconnect, reconnectTimeout);

            }

            function onMessageArrived(msg){
                out_msg = msg.payloadString;
                console.log(out_msg);
            }

            function MQTTconnect() {
                document.getElementById("messages").innerHTML = "";
                var s = document.forms["con"]["sname"].value;
                var p = document.forms["con"]["pname"].value;

                if(s != "") {
                    host = s;
                    console.log("host = " + host);
                }

                if(p != "") {
                    port = parseInt(p);
                    console.log("port = " + port)
                }

                console.log("Connecting to " + host + " " + port);

                var x = Math.floor(Math.random() * 10000);
                var cname = "clientId-" + x;
                mqtt = new Paho.MQTT.Client(host, port, cname);
                var options = {
                    timeout: 4000,
                    onSuccess: onConnect,
                    onFailure: onFailure,
                };

                mqtt.onMessageArrived = onMessageArrived;
                mqtt.onConnectionLost = onConnectionLost;
                mqtt.connect(options);

                return false; 
            }

            function subscribeTopic(){

            }

            function sendMessage(){
                
            }

        </script>
        <title>Lab 4 Map</title>
    </head>
    <body>
        <h1>
            Lab 4 App
        </h1>
        <br/>
        
        <h3>
            Connection Status:
        </h3>
        <p id="status">Not Connected</p>
        <br/>

        <h2>
            Connect:
        </h2>
        <form id = "con">
            <label for="sname">Server:</label><br>
            <input type="text" id="sname" name="sname"><br>
            <label for="pname">Port:</label><br>
            <input type="text" id="pname" name="pname"><br><br>
            <input type="submit" value="Start">
            <input type="submit" value="End" style="margin-bottom:10px; margin-left: 20px;"><br><br>
        </form>
        <p id="constatus"></p>
        <br/>

        <h2>
            Subscribe to Topic:
        </h2>
        <form id="sub">
            <label for="tname">Topic:</label><br>
            <input type="text" id="tname" name="tname"><br><br>
            <input type="submit" value="Subscribe"><br><br>
        </form>
        <p id="substatus"></p>
        <br/>

        <h3>
            Messages:
        </h3>
        <p id="messages">No Messages</p>
        <br/>
    </body>
</html>