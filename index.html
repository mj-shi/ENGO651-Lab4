<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
        <script type = "text/javascript" language = "javascript">
            var mqtt;
            var reconnectTimeout = 4000;
            var host = "test.mosquitto.org";
            var port = 8080;
            var connection_flag = 0;
            var message = "";

            function onConnectionLost() {
                console.log("Connection lost");
                connection_flag = 0;
            }

            function onConnect() {
                var tmpStr = "Connected to " + host + " on port " + port;
                document.getElementById("constatus").innerHTML = "Successfully Connected.";
                document.getElementById("status").innerHTML = tmpStr;
                console.log(tmpStr);
                connection_flag = 1;
            }

            function onConnected(recon, url){
                console.log("onConnected");
            }

            function onFailure(){
                var tmpStr = "Connection Attempt to Host " + host + " on port " + port + " Failed. Attempting to Reconnect.";
                document.getElementById("constatus").innerHTML = tmpStr;
                console.log(tmpStr);
                setTimeout(MQTTconnect, reconnectTimeout);
            }

            function onMessageArrived(msg){
                message = msg.payloadString;
                document.getElementById("messages").innerHTML = message;
                console.log("Received: " + message);
            }

            function MQTTconnect() {
                if(connection_flag == 1){
                    var tmpStr = "Already Connected to " + host + "|" + port + ". Click end for new session.";
                    document.getElementById("constatus").innerHTML = tmpStr;
                    console.log(tmpStr);
                    return;
                }
                document.getElementById("messages").innerHTML = "";
                var s = document.forms["con"]["sname"].value;
                var p = document.forms["con"]["pname"].value;

                if(s != "") {
                    host = s;
                    console.log("host = " + host);
                }

                if(p != "") {
                    port = parseInt(p);
                    console.log("port = " + port)
                }

                console.log("Connecting to " + host + " " + port);

                var x = Math.floor(Math.random() * 10000);
                var cname = "clientId-" + x;

                mqtt = new Paho.MQTT.Client(host, port, cname);
                var options = {
                    timeout: 4000,
                    onSuccess: onConnect,
                    onFailure: onFailure,
                };

                mqtt.onMessageArrived = onMessageArrived;
                mqtt.onConnectionLost = onConnectionLost;
                mqtt.connect(options);

            }

            function closeConnection(){
                if(connection_flag == 0){
                    var tmpStr = "Not connected to any session.";
                    document.getElementById("constatus").innerHTML = tmpStr;
                    console.log(tmpStr);
                    return;
                }
                mqtt.disconnect();
                var tmpStr = "Disconnected from " + host + " | " + port;
                document.getElementById("constatus").innerHTML = tmpStr;
                document.getElementById("status").innerHTML = "Not Connected";
                console.log(tmpStr);
                connection_flag = 0;
            }

            function subscribeTopic(){
                document.getElementById("substatus").innerHTML = "";
                if(connection_flag == 0){
                    var tmpStr = "Not connected to any session.";
                    document.getElementById("substatus").innerHTML = tmpStr;
                    console.log(tmpStr);
                    return;
                }

                var subtopic = document.forms["sub"]["tname"].value;
                mqtt.subscribe(subtopic);
                console.log("Subbed to topic: " + subtopic);
                document.getElementById("substatus").innerHTML = "Subbed to topic: " + subtopic;
            }

            function sendMessage(){
                document.getElementById("msgstatus").innerHTML = "";
                if(connection_flag == 0){
                    var tmpStr = "Not connected to any session.";
                    document.getElementById("msgstatus").innerHTML = tmpStr;
                    console.log(tmpStr);
                    return;
                }

                var messageText = document.forms["msg"]["msgtext"].value;
                var topic = document.forms["msg"]["mtname"].value;

                message = new Paho.MQTT.Message(messageText);

                if (topic != "") {
                    message.destinationName = topic;
                } else {
                    message.destinationName = "default-topic";
                }
                mqtt.send(message);
                console.log("Message: " + messageText + " sent.")
                document.getElementById("msgstatus").innerHTML = "Message sent.";
            }

        </script>
        <title>Lab 4</title>
    </head>
    <body>
        <h1>
            Lab 4 App
        </h1>
        <br/>
        
        <h3>
            Connection Status:
        </h3>
        <p id="status">Not Connected</p>
        <br/>

        <h2>
            Connect:
        </h2>
        <form id = "con">
            <label for="sname">Server:</label><br>
            <input type="text" id="sname" name="sname"><br>
            <label for="pname">Port:</label><br>
            <input type="text" id="pname" name="pname"><br><br>
            <input type="button" value="Start" onclick="MQTTconnect()">
            <input type="button" value="End" style="margin-bottom:10px; margin-left: 20px;" onclick="closeConnection()"><br><br>
        </form>
        <p id="constatus"></p>
        <br/>

        <h2>
            Subscribe to Topic:
        </h2>
        <form id="sub">
            <label for="tname">Subscription Topic:</label><br>
            <input type="text" id="tname" name="tname"><br><br>
            <input type="button" value="Subscribe" onclick="subscribeTopic()"><br><br>
        </form>
        <p id="substatus"></p>
        <br/>

        <h2>
            Send Message:
        </h2>
        <form id="msg">
            <label for="mtname">Publish Topic:</label><br>
            <input type="text" id="mtname" name="mtname"><br><br>
            <label for="msgtext">Message:</label><br>
            <input type="text" id="msgtext" name="msgtext"><br><br>
            <input type="button" value="Send" onclick="sendMessage()"><br><br>
        </form>
        <p id="msgstatus"></p>
        <br/>

        <h3>
            Messages:
        </h3>
        <p id="messages">No Messages</p>
        <br/>
        <script src="./script.js"></script>
    </body>
</html>